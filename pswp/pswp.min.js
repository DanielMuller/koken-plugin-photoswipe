var initPhotoSwipeFromDOM=function(options){var parseThumbnailElements=function(a){var b=[];return a.children("img").each(function(){if("undefined"!=typeof $(this).attr("data-base")&&"undefined"!=typeof $(this).attr("data-extension")&&"undefined"!=typeof $(this).attr("data-presets")){var a={},c=$(this).attr("data-base"),d=$(this).attr("data-extension");a._common={msrc:$(this).attr("data-src")||$(this).attr("src")},a.title=$(this).attr("data-alt")||$(this).attr("alt"),a.caption=$(this).nextAll(".item-caption:first").html(),a.pid=c.split("/").slice(-3).join("-").slice(0,-1).toLowerCase(),jQuery.each($(this).attr("data-presets").split(" "),function(b,e){var f=e.split(","),g=f[0],h=isHighDensity()?2:1,i=isHighDensity()?".2x.":".",j=parseInt(f[1]),k=parseInt(f[2]),l=c+g+i+d;a[g]={src:l,w:h*j,h:h*k},"huge"==g&&(a["huge.2x"]={src:c+g+".2x."+d,w:2*j,h:2*k})}),itemExists=!1,$.each(b,function(b,c){if(c.pid==a.pid)return itemExists=!0,!1}),itemExists||b.push(a)}}),b},photoswipeParseHash=function(){var a=window.location.hash.substring(1),b={};if(a.length<5)return b;for(var c=a.split("&"),d=0;d<c.length;d++)if(c[d]){var e=c[d].split("=");e.length<2||(b[e[0]]=e[1])}return b.gid&&(b.gid=parseInt(b.gid,10)),b},openPhotoSwipe=function(index,disableAnimation,fromURL){var pswpElement=$(".pswp")[0],gallery,options,items;if(pswp_open)return!0;items=parseThumbnailElements(galleryElements),availableShareButtons={facebook:{id:"facebook",label:"Share on Facebook",url:"https://www.facebook.com/sharer/sharer.php?u={{url}}"},twitter:{id:"twitter",label:"Tweet",url:"https://twitter.com/intent/tweet?text={{text}}&url={{url}}"},pinterest:{id:"pinterest",label:"Pin it",url:"http://www.pinterest.com/pin/create/button/?url={{url}}&media={{image_url}}&description={{text}}"},gplus:{id:"gplus",label:"Google+",url:"https://plus.google.com/share?url={{url}}"},tumblr:{id:"tumblr",label:"Tumblr",url:"http://www.tumblr.com/share/photo?caption={{text}}&click_thru={{url}}&source={{image_url}}"},download:{id:"download",label:"Download Image",url:"{{raw_image_url}}",download:!0}};var shareButtons=Array();if($.each(koken_options.sharing,function(index,value){shareButtons.push(eval("availableShareButtons."+value))}),options={preload:[5,10],getThumbBoundsFn:function(a){return el=$("[data-pswp-uid='"+a+"']").children("img[data-presets]"),"undefined"==typeof el.offset()?{x:0,y:0,w:200}:{x:el.offset().left,y:el.offset().top,w:el.width()}},shareButtons:shareButtons,getImageURLForShare:function(a){return a.download&&koken_options.download_full?(download_version="huge",koken_options.hidpi===!0&&(download_version="huge.2x"),gallery.currItem[download_version].src):gallery.currItem.src||""},shareEl:shareButtons.length>0,getDoubleTapZoom:function(){return window.devicePixelRatio>1?.5:1},galleryPIDs:!0,addCaptionHTMLFn:function(a,b,c){return koken_options.showTitle&&a.title?(b.children[0].innerHTML=a.title+(a.caption?"<br/><small>"+a.caption+"</small>":""),!0):(b.children[0].innerHTML="",!1)}},fromURL)if(options.galleryPIDs){for(var j=0;j<items.length;j++)if(items[j].pid==index){options.index=j;break}}else options.index=parseInt(index,10)-1;else options.index=parseInt(index,10);if(!isNaN(options.index)){disableAnimation&&(options.showAnimationDuration=0),gallery=new PhotoSwipe(pswpElement,PhotoSwipeUI_Default,items,options);var realViewportWidth,useImageSize="medium_large",firstResize=!0,imageSrcWillChange;gallery.listen("beforeResize",function(){max_size=koken_options.max_size,size_factor=isHighDensity()?2:1,realViewportWidth=gallery.viewportSize.x*size_factor,realViewportWidth>=1600&&max_size>=1600&&"huge"in items[0]?(neededSize="huge",realViewportWidth>=2048&&max_size>=2048&&koken_options.hidpi===!0&&1==size_factor&&(neededSize="huge.2x")):realViewportWidth>=1024&&max_size>=1024&&"xlarge"in items[0]?neededSize="xlarge":realViewportWidth>=800&&max_size>=800&&"large"in items[0]?neededSize="large":neededSize="medium_large",useImageSize!=neededSize&&(useImageSize=neededSize,firstResize||gallery.invalidateCurrItems()),firstResize=!1}),gallery.listen("gettingData",function(a,b){b.src=b[useImageSize].src,b.msrc=b._common.msrc.replace(".crop.","."),b.w=b[useImageSize].w,b.h=b[useImageSize].h});var scroll_move=null,bind_move=!1;"object"==typeof $K&&"object"==typeof $K.keyboard&&("object"==typeof $K.keyboard.scroll&&"function"==typeof $K.keyboard.scroll.move&&(scroll_move=$K.keyboard.scroll.move,$K.keyboard.scroll.move=function(){return!0}),$("[data-bind-to-key]").each(function(){bind_move=!0;var a=$(this),b=a.attr("data-bind-to-key");key.unbind(b)})),gallery.listen("destroy",function(){bind_move===!0&&$K.keyboard.bind(),scroll_move&&($K.keyboard.scroll.move=scroll_move,scroll_move=null),pswp_open=!1,$(".pswp")[0].className="pswp",pswp_open_orientation!=window.orientation&&initPS(),pswp_open_width==$(window).width()&&pswp_open_height==$(window).height()||initPS()}),gallery.init(),pswp_open=!0,pswp_open_orientation=window.orientation,pswp_open_width=$(window).width(),pswp_open_height=$(window).height()}},isHighDensity=function(){return koken_options.hidpi!==!1&&(window.matchMedia&&(window.matchMedia("only screen and (min-resolution: 144dpi), only screen and (min-resolution: 1.3dppx), only screen and (min-resolution: 48.8dpcm)").matches||window.matchMedia("only screen and (-webkit-min-device-pixel-ratio: 1.3), only screen and (-o-min-device-pixel-ratio: 2.6/2), only screen and (min--moz-device-pixel-ratio: 1.3), only screen and (min-device-pixel-ratio: 1.3)").matches)||window.devicePixelRatio&&window.devicePixelRatio>1.3)},initPS=function(){koken_options.usingPillar||koken_options.usingPjaxWithoutPillar?setTimeout(runInitPS,500):runInitPS()},runInitPS=function(){pswp_open||($(".pswp")[0].className="pswp",$("a[data-pswp-uid]").removeAttr("data-pswp-upid"));var a=0;koken_options.usingPillar&&!koken_options.usingPjaxWithoutPillar?("size_0"==size_group&&"undefined"==typeof start_size_group&&(old_size_group=size_group,class_attr=$("div.pillar").attr("class"),class_attr&&(start_size_group=$.grep(class_attr.split(" "),function(a){return"pillar"!=a})[0])),orientation_changed&&("size_0"==size_group&&(size_group=start_size_group),old_size_group=size_group,class_attr=$("div.pillar:not(."+old_size_group+")").attr("class"),class_attr&&(size_group=$.grep(class_attr.split(" "),function(a){return"pillar"!=a})[0]),orientation_changed=!1),galleryElements=$("div.pillar:not(."+old_size_group+") "+koken_options.triggerEl)):galleryElements=$(koken_options.triggerEl),pswp_open||(galleryElements.each(function(){$(this).children("img").length>0&&(set_link($(this),a),a++)}),galleryElements.each(function(){$(this).attr("title")==koken_options.view_in_lightbox&&(lb_url=$(this).attr("href"),"undefined"!=typeof lb_url&&lb_url.length>0&&(lb_element=$(this),$('a[href="'+lb_url+'"]').each(function(){$(this).attr("data-pswp-uid")&&$(this).children("img").length>0&&set_link(lb_element,$(this).attr("data-pswp-uid"))})))}))},set_link=function(a,b){a.parent().hasClass("type_video")||a.click(function(b){return openPhotoSwipe(a.first().attr("data-pswp-uid")),!1}),a.attr("data-pswp-uid",b)},koken_options=options,pswp_open=!1,pswp_open_orientation,orientation_changed=!1,orientation=window.orientation,size_group="size_0",old_size_group,start_size_group,galleryElements=$(koken_options.triggerEl),last_resize=0;$(window).on("k-resize",function(){Date.now()-last_resize>1e3&&(last_resize=Date.now(),initPS())}),koken_options.usingPillar||koken_options.usingPjaxWithoutPillar?($(document).on("pjax:end",function(){initPS()}),$(window).on("orientationchange",function(){window.orientation!=orientation?(orientation_changed=!0,orientation=window.orientation,initPS()):orientation_changed=!1}),$(window).on("k-infinite-loaded",function(){initPS()}),initPS()):initPS();var hashData=photoswipeParseHash();hashData.pid&&hashData.gid&&openPhotoSwipe(hashData.pid,!0,!0)};
